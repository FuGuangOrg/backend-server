name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  VCPKG_BINARY_SOURCES: "clear;files,${{ github.workspace }}/vcpkg-bincache,readwrite"

jobs:
  build:
    name: Windows Build (MSVC 2022)
    runs-on: windows-latest

    steps:
      - name: Checkout main repo
        uses: actions/checkout@v4
        with:
          submodules: false
          persist-credentials: false

      - name: Fetch private submodule (inspection-algo)
        run: |
          git config --global url."https://x-access-token:${{ secrets.ALGO_REPO_PAT }}@github.com/".insteadOf "https://github.com/"
          git submodule update --init --recursive
        shell: bash

      - name: Cache vcpkg binary packages
        uses: actions/cache@v4
        with:
          path: ${{ github.workspace }}/vcpkg-bincache
          key: vcpkg-x64-windows-${{ hashFiles('vcpkg.json') }}-84bab45d-v2
          restore-keys: vcpkg-x64-windows-

      - name: Setup vcpkg
        uses: lukka/run-vcpkg@v11
        with:
          vcpkgGitCommitId: '84bab45d415d22042bd0b9081aea57f362da3f35'

      - name: vcpkg integrate
        run: '& "$env:VCPKG_ROOT\vcpkg" integrate install'
        shell: powershell

      - name: Install vcpkg packages
        run: '& "$env:VCPKG_ROOT\vcpkg" install --triplet x64-windows --x-install-root "$env:GITHUB_WORKSPACE\vcpkg_installed"'
        shell: powershell
        working-directory: ${{ github.workspace }}

      - name: Verify opencv installed
        run: |
          $opencv = "$env:GITHUB_WORKSPACE\vcpkg_installed\x64-windows\include\opencv4\opencv2\opencv.hpp"
          if (Test-Path $opencv) {
            Write-Host "opencv found: $opencv"
          } else {
            Write-Host "opencv NOT found; listing vcpkg_installed:"
            Get-ChildItem "$env:GITHUB_WORKSPACE\vcpkg_installed\x64-windows\include" -Recurse -Depth 2 -ErrorAction SilentlyContinue
            exit 1
          }
        shell: powershell

      - name: Install Qt
        uses: jurplel/install-qt-action@v3
        with:
          version: '6.9.2'
          arch: 'win64_msvc2022_64'
          cache: true

      - name: Install Qt VS Tools (QtMsBuild integration)
        run: |
          $body = '{"filters":[{"criteria":[{"filterType":7,"value":"TheQtCompany.QtVisualStudioTools2022"}]}],"flags":512}'
          $result = Invoke-RestMethod `
            -Uri "https://marketplace.visualstudio.com/_apis/public/gallery/extensionquery?api-version=3.0-preview.1" `
            -Method POST -Body $body `
            -ContentType "application/json" `
            -UseBasicParsing
          $version = $result.results[0].extensions[0].versions[0].version
          Write-Host "Qt VS Tools version: $version"

          $vsixUrl = "https://marketplace.visualstudio.com/_apis/public/gallery/publishers/TheQtCompany/vsextensions/QtVisualStudioTools2022/$version/vspackage"
          Invoke-WebRequest -Uri $vsixUrl -OutFile "$env:RUNNER_TEMP\qt-vstools.vsix" -UseBasicParsing

          Rename-Item "$env:RUNNER_TEMP\qt-vstools.vsix" "$env:RUNNER_TEMP\qt-vstools.zip"
          Expand-Archive -Path "$env:RUNNER_TEMP\qt-vstools.zip" -DestinationPath "$env:RUNNER_TEMP\qt-vstools" -Force

          $qtmsbuild = (Get-ChildItem "$env:RUNNER_TEMP\qt-vstools" -Filter "QtMsBuild" -Recurse -Directory | Select-Object -First 1).FullName
          if (-not $qtmsbuild) { throw "QtMsBuild directory not found in extracted VSIX" }

          Write-Host "QTMSBUILD=$qtmsbuild"
          Add-Content $env:GITHUB_ENV "QTMSBUILD=$qtmsbuild"
        shell: powershell

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v1

      - name: Register Qt installation for QtMsBuild
        run: |
          # Find Qt root
          $qtRoot = $null
          foreach ($varName in @("QT_ROOT_DIR", "Qt6_DIR", "Qt6_Dir")) {
            $val = [Environment]::GetEnvironmentVariable($varName)
            if ($val) {
              Write-Host "Found $varName=$val"
              $qtRoot = $val
              break
            }
          }
          
          if (-not $qtRoot) {
            $qmake = Get-ChildItem "$env:RUNNER_WORKSPACE" -Recurse -Filter "qmake.exe" -ErrorAction SilentlyContinue | Select-Object -First 1
            if ($qmake) { $qtRoot = $qmake.Directory.Parent.FullName }
          }
          
          if (-not $qtRoot) { throw "Cannot find Qt installation directory" }
          
          # Strip lib/cmake/Qt6 suffix if present
          if ($qtRoot -match '[\\/]lib[\\/]cmake[\\/]Qt6$') {
            $qtRoot = $qtRoot -replace '[\\/]lib[\\/]cmake[\\/]Qt6$', ''
          }
          
          Write-Host "Qt root: $qtRoot"
          
          # Register in BOTH possible registry locations
          foreach ($regPath in @("HKCU:\Software\Digia\Versions", "HKCU:\Software\QtProject\Versions")) {
            New-Item -Path $regPath -Force | Out-Null
            New-ItemProperty -Path $regPath -Name "6.9.2_msvc2022_64" -Value "$qtRoot" -Force | Out-Null
            Write-Host "Registered at $regPath\6.9.2_msvc2022_64 -> $qtRoot"
          }
          
          # Also set QTDIR env var as fallback
          Add-Content $env:GITHUB_ENV "QTDIR=$qtRoot"
          
          # Verify
          if (Test-Path "$qtRoot\bin\qmake.exe") {
            Write-Host "âœ… qmake found at $qtRoot\bin\qmake.exe"
          } else {
            Write-Host "WARNING: qmake not found, listing:"
            Get-ChildItem $qtRoot -Depth 1 -ErrorAction SilentlyContinue
          }
        shell: powershell

      - name: Build Release
        run: |
          msbuild fuguang-server.sln `
            "/t:common;event_bus;motion_control" `
            /p:Configuration=Release `
            /p:Platform=x64 `
            /p:QtMsBuild="$env:QTMSBUILD" `
            /p:QtToolsPath="$env:QTDIR\bin" `
            /p:VcpkgInstalledDir="$env:GITHUB_WORKSPACE\vcpkg_installed\" `
            /verbosity:normal
        shell: powershell

      - name: Upload build artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: fuguang-server-release
          path: bin/Release/*.dll
          retention-days: 7
