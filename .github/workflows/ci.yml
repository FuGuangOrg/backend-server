name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  VCPKG_BINARY_SOURCES: "clear"

jobs:
  build:
    name: Windows Build (MSVC 2022)
    runs-on: windows-latest

    steps:
      - name: Checkout main repo
        uses: actions/checkout@v4
        with:
          submodules: false
          persist-credentials: false

      - name: Fetch private submodule (inspection-algo)
        run: |
          git config --global url."https://x-access-token:${{ secrets.ALGO_REPO_PAT }}@github.com/".insteadOf "https://github.com/"
          git submodule update --init --recursive
        shell: bash

      - name: Export vcpkg binary cache env vars
        uses: actions/github-script@v7
        with:
          script: |
            core.exportVariable('ACTIONS_CACHE_URL', process.env.ACTIONS_CACHE_URL || '');
            core.exportVariable('ACTIONS_RUNTIME_TOKEN', process.env.ACTIONS_RUNTIME_TOKEN || '');

      - name: Setup vcpkg
        uses: lukka/run-vcpkg@v11
        with:
          vcpkgGitCommitId: '84bab45d415d22042bd0b9081aea57f362da3f35'

      - name: vcpkg integrate
        run: '& "$env:VCPKG_ROOT\vcpkg" integrate install'
        shell: powershell

      - name: Install Qt
        uses: jurplel/install-qt-action@v3
        with:
          version: '6.9.2'
          arch: 'win64_msvc2022_64'
          cache: true

      - name: Install Qt VS Tools (QtMsBuild integration)
        run: |
          $body = '{"filters":[{"criteria":[{"filterType":7,"value":"TheQtCompany.QtVisualStudioTools2022"}]}],"flags":512}'
          $result = Invoke-RestMethod `
            -Uri "https://marketplace.visualstudio.com/_apis/public/gallery/extensionquery?api-version=3.0-preview.1" `
            -Method POST -Body $body `
            -ContentType "application/json" `
            -UseBasicParsing
          $version = $result.results[0].extensions[0].versions[0].version
          Write-Host "Qt VS Tools version: $version"

          $vsixUrl = "https://marketplace.visualstudio.com/_apis/public/gallery/publishers/TheQtCompany/vsextensions/QtVisualStudioTools2022/$version/vspackage"
          Invoke-WebRequest -Uri $vsixUrl -OutFile "$env:RUNNER_TEMP\qt-vstools.vsix" -UseBasicParsing

          Rename-Item "$env:RUNNER_TEMP\qt-vstools.vsix" "$env:RUNNER_TEMP\qt-vstools.zip"
          Expand-Archive -Path "$env:RUNNER_TEMP\qt-vstools.zip" -DestinationPath "$env:RUNNER_TEMP\qt-vstools" -Force

          $qtmsbuild = (Get-ChildItem "$env:RUNNER_TEMP\qt-vstools" -Filter "QtMsBuild" -Recurse -Directory | Select-Object -First 1).FullName
          if (-not $qtmsbuild) { throw "QtMsBuild directory not found in extracted VSIX" }

          Write-Host "QTMSBUILD=$qtmsbuild"
          Add-Content $env:GITHUB_ENV "QTMSBUILD=$qtmsbuild"
        shell: powershell

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v1

      - name: Build Release
        run: |
          msbuild fuguang-server.sln `
            /p:Configuration=Release `
            /p:Platform=x64 `
            /p:QtMsBuild="$env:QTMSBUILD" `
            /p:QtInstall="$env:Qt6_DIR" `
            /p:VcpkgEnableManifest=true `
            /p:VcpkgManifestRoot="$env:GITHUB_WORKSPACE" `
            /p:VcpkgInstalledDir="$env:GITHUB_WORKSPACE\vcpkg_installed\" `
            /verbosity:normal
        shell: powershell

      - name: Upload build artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: fuguang-server-release
          path: bin/Release/fiber_end_server.exe
          retention-days: 7
